!
function(d) {
    var e = function(b, c) {
        var a = ["maxHeight", "upload", "target", "csrftoken"];
        d.each(a,
        function(j, i) {
            if (typeof d(b).data(i) !== "undefined") {
                c = typeof c == "object" ? c: {};
                c[i] = d(b).data(i)
            }
        });
        this.$a = d(b);
        this.$b = d.extend(true, {},
        d.fn.imgclip.defaults, c, this.$a.data("options"));
        this.$c = typeof d.cookie === "function" ? d.cookie("csrftoken") : "x";
        this.$d = null;
        this.$e = null;
        this.$f = null;
        this.$g = null;
        this.$h = null;
        this.$i = null;
        this.$j = null;
        this.$k = null;
        this.$l = null;
        this.$m = null;
        this.$n = null;
        this.$o = {
            s: null,
            e: null
        };
        this.$p = 0;
        this.$q = 0;
        this.$r = 1;
        this.$s = false;
        this.$t = false;
        this.$u = false;
        this.$v = null;
        this.A()
    };
    e.prototype = {
        constructor: e,
        X: function() {
            this.$o = {
                s: null,
                e: null
            };
            this.$s = false;
            this.$t = false;
            this.$u = false;
            this.$d.hide();
            this.$e.show()
        },
        A: function() {
            var J = this,
            N = this.$a;
            if (this.$e === null) {
                var L = d("<div/>", {
                    "class": "imgclip-panel"
                }),
                c = d("<div/>", {
                    "class": "imgclip-layer"
                }).hide(),
                K = d("<div/>", {
                    "class": "imgclip-select"
                }).hide(),
                H = d("<div/>", {
                    "class": "imgclip-dialog"
                }).hide(),
                a = d("<div/>", {
                    "class": "d t l"
                }),
                b = d("<div/>", {
                    "class": "d t r"
                }),
                y = d("<div/>", {
                    "class": "d b l"
                }),
                z = d("<div/>", {
                    "class": "d b r"
                }),
                A = d("<div/>", {
                    "class": "d t x"
                }),
                B = d("<div/>", {
                    "class": "d b x"
                }),
                D = d("<div/>", {
                    "class": "d l y"
                }),
                E = d("<div/>", {
                    "class": "d r y"
                }),
                C,
                M = d("<canvas/>", {
                    "id": "imgclip-canvas",
                    "class": "imgclip-canvas"
                }).hide(),
                I = d("<canvas/>", {
                    "id": "_cv",
                    "class": "hidden"
                }).hide(),
                O = d("<input />", {
                    "class": "imgclip-submit-btn btn btn-primary",
                    "type": "button",
                    "value": "上传"
                }).click(function() {
                    J.G()
                }),
                F = d("<input />", {
                    "class": "imgclip-cancel-btn btn btn-default",
                    "type": "button",
                    "value": "重新选择"
                }).click(function() {
                    J.X()
                }),
                G = d("<img/>", {
                    "class": "imgclip-output"
                }).bind("dblclick",
                function() {
                    J.X()
                });
                if (N.is("input")) {
                    N.before(L);
                    K.append(a).append(b).append(y).append(z);
                    K.append(A).append(B).append(D).append(E);
                    L.append(M).append(c).append(K).append(N);
                    H.append(G).append(O).append(F);
                    L.after(I).after(H).before(d("<p/>", {
                        "clear": "both"
                    }));
                    N.addClass("btn btn-default");
                    M.mousedown(function(g) {
                        J.$t = true;
                        J.$o.s = J.I(g);
                        J.C();
                        g.preventDefault();
                        g.stopPropagation()
                    });
                    L.mouseup(function(g) {
                        J.$u = false
                    }).mousemove(function() {
                        if (J.$u || J.$s || J.$t) {
                            K.addClass("imgclip-move");
                            d(".d").addClass("sd")
                        } else {
                            K.removeClass("imgclip-move");
                            d(".d").removeClass("sd")
                        }
                    });
                    c.mousedown(function(g) {
                        J.$t = true;
                        J.$s = false;
                        J.$o.s = J.I(g);
                        J.$o.e = null;
                        J.C();
                        g.preventDefault();
                        g.stopPropagation()
                    }).mousemove(function(g) {
                        if (J.$t) {
                            J.$o.e = J.I(g);
                            J.C()
                        } else {
                            if (J.$s) {
                                J.D(g)
                            } else {
                                if (J.$u) {
                                    J.E(g)
                                }
                            }
                        }
                    });
                    K.mousedown(function(g) {
                        J.$s = true;
                        g.preventDefault();
                        g.stopPropagation()
                    }).mouseup(function(g) {
                        J.$u = false
                    }).mousemove(function(g) {
                        if (J.$t) {
                            J.$o.e = J.I(g);
                            J.C()
                        } else {
                            if (J.$s) {
                                J.D(g)
                            } else {
                                if (J.$u) {
                                    J.E(g)
                                }
                            }
                        }
                    }).click(function() {
                        J.$s = J.$s ? false: true
                    }).dblclick(function() {
                        J.$t = false;
                        J.$s = false;
                        K.removeClass("imgclip-move");
                        c.hide();
                        K.hide();
                        L.hide();
                        H.show();
                        J.F()
                    });
                    d(".d").on("mousedown mouseup click",
                    function(g) {
                        g.preventDefault();
                        g.stopPropagation()
                    }).mousemove(function(g) {
                        if (J.$u) {
                            g.preventDefault();
                            g.stopPropagation();
                            J.E(g)
                        }
                    }).mousedown(function(g) {
                        if (!J.$t) {
                            J.$u = J.$u ? false: true;
                            if (J.$u) {
                                J.$v = d(this)
                            }
                        } else {
                            J.$t = false
                        }
                    }).mouseup(function(g) {
                        J.$t = false;
                        J.$u = false
                    });
                    this.$e = L;
                    this.$d = H;
                    this.$k = N;
                    this.$f = document.getElementById("imgclip-canvas");
                    this.$g = document.getElementById("_cv");
                    this.$h = c;
                    this.$i = K;
                    this.$k.change(function(g) {
                        M.show();
                        J.$h.hide();
                        J.$i.hide();
                        J.H(this)
                    }).click(function() {
                        d(".imgclip-output").remove();
                        O.before(G.bind("dblclick",
                        function() {
                            J.X()
                        }))
                    })
                }
            } else {
                this.$e.show()
            }
            return this
        },
        B: function() {
            var a = this,
            i = this.$f,
            j, c = a.$b.maxHeight,
            b = this.$m;
            a.$d.hide();
            this.$l = new Image();
            this.$l.onload = function() {
                if (this.height > c) {
                    a.$r = c / this.height;
                    this.width *= c / this.height;
                    this.height = c
                }
                a.$p = this.width;
                a.$q = this.height;
                j = i.getContext("2d");
                j.clearRect(0, 0, i.width, i.height);
                i.width = this.width;
                i.height = this.height;
                j.drawImage(this, 0, 0, this.width, this.height)
            };
            this.$l.src = b
        },
        C: function() {
            var n = this,
            q = this.$j,
            r = this.$o,
            o = this.$h,
            c = this.$i;
            this.$h.width(q.width).height(q.height).show();
            if (r.s === null || r.e === null) {
                return
            }
            var a = Math.abs(parseInt(r.e.x - r.s.x)),
            p = Math.abs(parseInt(r.e.y - r.s.y)),
            b = Math.min(r.e.y, r.s.y),
            h = Math.min(r.e.x, r.s.x);
            this.$i.width(a).height(p).css({
                "top": b + "px",
                "left": h + "px",
                "background-image": "url(" + n.$f.toDataURL("image/png") + ")",
                "background-position": ( - 1 * h) + "px" + " " + ( - 1 * b) + "px"
            }).show()
        },
        D: function(q) {
            var s = this,
            h = this.$o,
            u = this.I(q),
            a = Math.abs(parseInt((h.s.x - h.e.x) / 2)),
            t = Math.abs(parseInt((h.s.y - h.e.y) / 2)),
            b,
            c,
            p,
            r;
            b = u.x - a;
            c = u.y - t;
            p = u.x + a;
            r = u.y + t;
            if (! (b >= 0 && b <= this.$p && c >= 0 && c <= this.$q) || !(p >= 0 && p <= this.$p && r >= 0 && r <= this.$q)) {
                return
            }
            this.$o.s.x = b;
            this.$o.s.y = c;
            this.$o.e.x = p;
            this.$o.e.y = r;
            this.$i.css({
                "top": c + "px",
                "left": b + "px",
                "background-position": ( - 1 * b) + "px" + " " + ( - 1 * c) + "px"
            })
        },
        E: function(c) {
            var a = this,
            b = this.$v,
            j = a.I(c);
            if (b.is(".t") && b.is(".l")) {
                a.$o.s = j
            } else {
                if (b.is(".t") && b.is(".r")) {
                    a.$o.s.y = j.y;
                    a.$o.e.x = j.x
                } else {
                    if (b.is(".b") && b.is(".l")) {
                        a.$o.s.x = j.x;
                        a.$o.e.y = j.y
                    } else {
                        if (b.is(".b") && b.is(".r")) {
                            a.$o.e = j
                        } else {
                            if (b.is(".t") && b.is(".x")) {
                                a.$o.s.y = j.y
                            } else {
                                if (b.is(".b") && b.is(".x")) {
                                    a.$o.e.y = j.y
                                } else {
                                    if (b.is(".l") && b.is(".y")) {
                                        a.$o.s.x = j.x
                                    } else {
                                        if (b.is(".r") && b.is(".y")) {
                                            a.$o.e.x = j.x
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            a.C()
        },
        F: function() {
            var q = this,
            t = this.$l,
            s = this.$g,
            a, p = this.$o,
            c = Math.min(p.e.x, p.s.x),
            o = Math.min(p.e.y, p.s.y),
            b = Math.abs(parseInt(p.e.x - p.s.x)),
            r = Math.abs(parseInt(p.e.y - p.s.y));
            if (p.e === null && p.s !== null) {
                return true
            }
            a = s.getContext("2d");
            a.clearRect(0, 0, s.width, s.height);
            s.width = b;
            s.height = r;
            a.drawImage(t, parseInt(c / q.$r), parseInt(o / q.$r), parseInt(b / q.$r), parseInt(r / q.$r), 0, 0, b, r);
            var u = d(".imgclip-output"),
            v = s.toDataURL("image/jpg");
            u.attr({
                "src": v
            });
            q.$n = window.dataURLtoBlob && window.dataURLtoBlob(v)
        },
        G: function() {
            if (this.$b.upload.url === null || !this.$b.upload.url) {
                console.log("You must config the upload.url section");
                return
            }
            var k = this,
            r = this.$b.upload.url,
            q = this.$b.upload.name,
            o = this.$b.upload.extraData,
            c = d(this.$b.target),
            b = this.$c,
            p = new FormData(),
            a = new XMLHttpRequest();
            p.append(q, this.$n);
            for (var n in o) {
                p.append(n, o[n])
            }
            a.upload.onerror = function() {
                console.log("Error")
            };
            a.onreadystatechange = function() {
                if (a.readyState === 4 && a.status === 200) {
                    var g = d.parseJSON(a.responseText);
                    if (g && !!g["url"] && g["url"]) {
                        c.val(g.url);
                        d("input.btn", k.$d).hide();
                        d("img", k.$d).unbind()
                    }
                }
            };
            a.open("POST", r, true);
            if (!this.crossDomain) {
                a.setRequestHeader("X-CSRFToken", b)
            }
            a.setRequestHeader("Cache-Control", "no-cache");
            a.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            a.send(p)
        },
        H: function(b) {
            var a = this,
            c = new FileReader();
            if (!b.files || !b.files[0]) {
                return
            }
            c.onload = function(h) {
                a.$m = h.target.result;
                a.B()
            };
            c.readAsDataURL(b.files[0])
        },
        I: function(a) {
            var b = this.$f,
            c = b.getBoundingClientRect();
            this.$j = c;
            return {
                x: parseInt(a.clientX - c.left * (b.width / c.width)),
                y: parseInt(a.clientY - c.top * (b.height / c.height))
            }
        }
    };
    d.fn.imgclip = function(a) {
        return this.each(function() {
            var b = d(this),
            c = b.data("imgclip"),
            h = typeof a == "object" && a;
            if (!c) {
                b.data("imgclip", (c = new e(this, h)))
            }
        })
    };
    d.fn.imgclip.messages = {};
    d.fn.imgclip.defaults = {
        maxHeight: 500,
        target: "input.imgclip-target",
        upload: {
            url: null,
            name: "x",
            extraData: {}
        },
        csrftoken: "token"
    };
    d.fn.imgclip.Constructor = e;
    var f = function(b) {
        var a = b;
        if (a.data("imgclip")) {
            a.data("imgclip").A();
            return
        }
        a.imgclip()
    };
    d(document).ready(function() {
        d('input[data-provide="imgclip"]').each(function() {
            f(d(this))
        })
    })
} (jQuery);